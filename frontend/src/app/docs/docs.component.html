<div class="docs">
    <!-- Article Viewer Modal -->
    <div class="article-viewer" *ngIf="viewingArticle">
        <div class="article-header">
            <button class="back-btn" (click)="closeArticle()">
                ‚Üê BACK TO LIST
            </button>
            <!-- AI Enhancement disabled for cost control - uncomment to re-enable
            <button class="ai-toggle-btn" [class.active]="aiEnhanced" [disabled]="enhancing"
                (click)="toggleAiEnhancement()">
                <span *ngIf="!enhancing">‚ú® {{ aiEnhanced ? 'AI Enhanced' : 'Enhance with AI' }}</span>
                <span *ngIf="enhancing">üîÑ Enhancing...</span>
            </button>
            -->
            <h2>{{ viewingArticle.title }}</h2>
            <button class="close-btn" (click)="closeArticle()">‚úï</button>
        </div>

        <div class="article-body">
            <div *ngIf="loadingArticle" class="loading-state">
                <div class="spinner"></div>
                <p>{{ loadingMessage }}</p>
            </div>
            <!-- Labor Operation View -->
            <div *ngIf="laborData && !loadingArticle" class="labor-view">
                <div class="labor-header">
                    <h3>{{ laborData.mainOperation.title }}</h3>
                    <p class="subtitle">{{ laborData.mainOperation.subtitle }}</p>
                </div>

                <table class="labor-table">
                    <thead>
                        <tr>
                            <th class="align-left">Operation</th>
                            <th class="align-left">Vehicle Attributes</th>
                            <th class="align-right">Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <strong>{{ laborData.mainOperation.title }}</strong>
                                <div *ngIf="laborData.includedOperations?.length > 0" class="included-ops">
                                    <br>+ Included:
                                    <div *ngFor="let inc of laborData.includedOperations" class="indent">
                                        {{ inc.title }}
                                    </div>
                                </div>
                            </td>
                            <td>{{ laborData.vehicleAttributes }}</td>
                            <td class="align-right">
                                {{ laborData.mainOperation.baseAdditionalDescription ? '(' +
                                laborData.mainOperation.baseAdditionalDescription + ')' : '' }}
                                {{ laborData.mainOperation.laborTime | number: '.1-2' }}
                                <div *ngIf="laborData.mainOperation.addMOTORLaborTime">
                                    ({{ laborData.mainOperation.addAdditionalDescription }}) {{
                                    laborData.mainOperation.addMOTORLaborTime | number: '.1-2' }}
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div *ngIf="laborData.notes?.length > 0" class="labor-notes">
                    <strong>Notes:</strong>
                    <ul>
                        <li *ngFor="let note of laborData.notes">{{ note.text }}</li>
                    </ul>
                </div>

                <div *ngIf="laborData.mainOperation?.parts?.length > 0" class="labor-parts">
                    <strong>Parts Required:</strong>
                    <table class="parts-table">
                        <thead>
                            <tr>
                                <th>Part Number</th>
                                <th>Description</th>
                                <th>Qty</th>
                                <th class="align-right">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let part of laborData.mainOperation.parts">
                                <td><strong>{{ part.partNumber }}</strong></td>
                                <td>{{ part.partDescription }}</td>
                                <td class="align-center">{{ part.quantity }}</td>
                                <td class="align-right">{{ part.price }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Optional Operations -->
                <div *ngIf="laborData.optionalOperations?.length > 0" class="optional-ops">
                    <h4>Optional Operations</h4>
                    <table class="labor-table">
                        <thead>
                            <tr>
                                <th class="align-left">Operation</th>
                                <th class="align-right">Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let op of laborData.optionalOperations">
                                <td>
                                    {{ op.title }}
                                    <div class="subtitle">{{ op.subtitle }}</div>
                                </td>
                                <td class="align-right">
                                    {{ op.baseAdditionalDescription ? '(' + op.baseAdditionalDescription + ')' : '' }}
                                    {{ op.laborTime | number: '.1-2' }}
                                    <div *ngIf="op.addMOTORLaborTime">
                                        ({{ op.addAdditionalDescription }}) {{ op.addMOTORLaborTime | number: '.1-2' }}
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div *ngIf="!loadingArticle && !laborData" class="article-html" [innerHTML]="articleContent"
                (click)="handleArticleClick($event)"></div>
        </div>
    </div>

    <!-- Main Docs View -->
    <div class="main-view" [class.blurred]="viewingArticle">
        <div class="header">
            <div class="vehicle-info">
                <div class="mini-car-container" #miniCarContainer></div>
                <div class="info">
                    <h1 class="glow-text" *ngIf="!loadingName">{{ vehicleName }}</h1>
                    <h1 class="glow-text" *ngIf="loadingName">Loading...</h1>
                    <p class="subtitle">TECHNICAL DOCUMENTATION</p>
                </div>
                <button class="change-vehicle" (click)="changeVehicle()">
                    CHANGE VEHICLE
                </button>
            </div>
        </div>

        <div *ngIf="error" class="error-message">{{ error }}</div>

        <div *ngIf="loading" class="loading">
            <div class="spinner"></div>
            <p>LOADING ARTICLES...</p>
        </div>

        <!-- Search and Controls -->
        <div *ngIf="!loading" class="controls-bar">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="üîç Search articles..." [(ngModel)]="searchQuery"
                    (input)="onSearchChange()">
                <button *ngIf="searchQuery" class="clear-search" (click)="searchQuery = ''; onSearchChange()">‚úï</button>
            </div>
        </div>

        <div class="content-layout" *ngIf="!loading && categories.length > 0">
            <!-- Category Quick Navigation -->
            <aside class="category-nav">
                <h3>CATEGORIES</h3>
                <div class="nav-list">
                    <div *ngFor="let category of categories" class="nav-group">
                        <button class="nav-item"
                            [class.active]="selectedCategory?.name === category.name && !selectedSubCategory"
                            (click)="selectCategory(category)">
                            <span class="nav-name">{{ category.name }}</span>
                            <span class="nav-count">{{ category.count }}</span>
                        </button>

                        <!-- Sub-categories Sidebar -->
                        <div *ngIf="category.subCategories && category.expanded" class="sub-nav-list">
                            <button *ngFor="let sub of category.subCategories" class="sub-nav-item"
                                [class.active]="selectedSubCategory?.name === sub.name"
                                (click)="selectSubCategory(sub, $event)">
                                <span class="sub-nav-name">{{ sub.name }}</span>
                                <span class="sub-nav-count">{{ sub.articles.length }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Articles Display Area -->
            <div class="articles-area">
                <!-- Show category title and articles when category selected -->
                <div *ngIf="selectedCategory" class="selected-category-view">
                    <div class="category-title">
                        <h2>
                            {{ selectedCategory.name }}
                            <span *ngIf="selectedSubCategory" class="sub-title"> > {{ selectedSubCategory.name }}</span>
                        </h2>
                        <span class="article-count">
                            {{ selectedSubCategory ? selectedSubCategory.articles.length : selectedCategory.count }}
                            articles
                        </span>
                    </div>


                    <div *ngIf="selectedCategory.name === 'Maintenance Schedules'" class="maintenance-search">
                        <form (ngSubmit)="searchMaintenanceSchedules()" class="search-form">
                            <div class="form-row">
                                <input type="number" class="interval-input" [(ngModel)]="maintenanceSchedule.interval"
                                    name="interval" placeholder="Enter interval..."
                                    [disabled]="maintenanceSchedule.intervalType === 'Indicator'">
                                <button type="submit" class="search-btn" [disabled]="maintenanceSchedule.searching">
                                    {{ maintenanceSchedule.searching ? 'SEARCHING...' : 'SEARCH' }}
                                </button>
                            </div>

                            <div class="form-row">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="intervalType" value="Miles"
                                            [(ngModel)]="maintenanceSchedule.intervalType">
                                        <span>Miles</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="intervalType" value="Kilometers"
                                            [(ngModel)]="maintenanceSchedule.intervalType">
                                        <span>Kilometers</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="intervalType" value="Months"
                                            [(ngModel)]="maintenanceSchedule.intervalType">
                                        <span>Months</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="intervalType" value="Indicator"
                                            [(ngModel)]="maintenanceSchedule.intervalType">
                                        <span>Indicator</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="severity" value="Normal"
                                            [(ngModel)]="maintenanceSchedule.severity">
                                        <span>Normal Service</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="severity" value="Severe"
                                            [(ngModel)]="maintenanceSchedule.severity">
                                        <span>Severe Service</span>
                                    </label>
                                </div>
                            </div>
                        </form>


                        <div *ngIf="maintenanceSchedule.searchCompleted" class="search-results">
                            <p class="results-info">Search results ready - displaying {{
                                (maintenanceSchedule.results.byInterval.length +
                                (maintenanceSchedule.results.byIndicator?.length || 0)) }} interval(s)</p>
                        </div>

                        <div *ngIf="!maintenanceSchedule.searchCompleted && !maintenanceSchedule.searching"
                            class="no-results">
                            <p>Enter an interval and click Search to view maintenance schedules</p>
                        </div>
                    </div>


                    <div *ngIf="selectedCategory.name !== 'Maintenance Schedules'">

                        <!-- Specific Sub-category View -->
                        <div *ngIf="selectedSubCategory" class="articles-grid">
                            <div *ngFor="let article of selectedSubCategory.articles" class="article-card neon-border"
                                (click)="viewArticle(article)">
                                <div class="article-icon">üìÑ</div>
                                <div class="article-info">
                                    <h3>{{ article.title || article.id || 'Untitled Article' }}</h3>
                                    <p class="description" *ngIf="article.subtitle">{{ article.subtitle }}</p>
                                    <p class="article-id" *ngIf="!article.title && article.id">ID: {{ article.id }}</p>
                                </div>
                                <button class="view-btn">VIEW ‚Üí</button>
                            </div>
                        </div>

                        <!-- Overview View (All Sub-categories) -->
                        <div
                            *ngIf="!selectedSubCategory && selectedCategory.subCategories && selectedCategory.subCategories.length > 0">
                            <div *ngFor="let subCat of selectedCategory.subCategories" class="sub-category-section">
                                <h3 class="sub-category-title">{{ subCat.name }}</h3>
                                <div class="articles-grid">
                                    <div *ngFor="let article of subCat.articles" class="article-card neon-border"
                                        (click)="viewArticle(article)">
                                        <div class="article-icon">üìÑ</div>
                                        <div class="article-info">
                                            <h3>{{ article.title || article.id || 'Untitled Article' }}</h3>
                                            <p class="description" *ngIf="article.subtitle">{{ article.subtitle }}</p>
                                            <p class="article-id" *ngIf="!article.title && article.id">ID: {{ article.id
                                                }}
                                            </p>
                                        </div>
                                        <button class="view-btn">VIEW ‚Üí</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Standard Flat View (No Sub-categories) -->
                        <div *ngIf="!selectedSubCategory && (!selectedCategory.subCategories || selectedCategory.subCategories.length === 0)"
                            class="articles-grid">
                            <div *ngFor="let article of selectedCategory.articles" class="article-card neon-border"
                                (click)="viewArticle(article)">
                                <div class="article-icon">üìÑ</div>
                                <div class="article-info">
                                    <h3>{{ article.title || article.id || 'Untitled Article' }}</h3>
                                    <p class="description" *ngIf="article.subtitle">{{ article.subtitle }}</p>
                                    <p class="article-id" *ngIf="!article.title && article.id">ID: {{ article.id }}</p>
                                </div>
                                <button class="view-btn">VIEW ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Show message when no category selected -->
                <div *ngIf="!selectedCategory" class="no-selection">
                    <div class="icon">üìë</div>
                    <h2>Select a Category</h2>
                    <p>Choose a category from the left to view articles</p>
                </div>
            </div>

            <div *ngIf="!loading && categories.length === 0 && !error" class="no-articles">
                <p *ngIf="!searchQuery">No articles found for this vehicle.</p>
                <p *ngIf="searchQuery">No articles match "{{ searchQuery }}"</p>
                <button class="change-vehicle" (click)="changeVehicle()">SELECT DIFFERENT VEHICLE</button>
            </div>
        </div>
    </div>