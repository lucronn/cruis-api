<div class="docs-container">
    <!-- HUD Header -->
    <div class="hud-header" [class.collapsed]="searchFocused || showSearch">
        <div class="hud-top-row">

            <h1 class="vehicle-title">{{ vehicleName }}</h1>
            <div class="mini-car-wrapper" #miniCarContainer></div>
        </div>



        <!-- Stat Carousel (Collapsible) -->
        <div class="stat-carousel" [class.hidden]="searchFocused || searchQuery">
            <div class="stat-card" *ngFor="let stat of hudStats">
                <span class="stat-icon">{{ stat.icon }}</span>
                <div class="stat-info">
                    <span class="stat-label">{{ stat.label }}</span>
                    <span class="stat-value">{{ stat.value }}</span>
                </div>
            </div>
            <!-- Loading State for Stats -->
            <div class="stat-card loading" *ngIf="loadingHud">
                <div class="skeleton-line"></div>
                <div class="skeleton-line short"></div>
            </div>
        </div>
    </div>

    <!-- Thumb Zone Navigation (Pills) -->
    <div class="pill-nav-container">
        <div class="pill-scroll-wrapper">
            <button class="nav-pill" *ngFor="let pill of pillFilters" [class.active]="activePill === pill"
                (click)="selectPill(pill)">
                {{ pill }}
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="content-area">
        <!-- Article List (Accordion Style) -->
        <div class="article-list"
            *ngIf="!viewingArticle && activePill !== 'DTCs' && activePill !== 'Diagnostic Codes' && activePill !== 'Diagnostic Trouble Codes' && activePill !== 'TSBs' && activePill !== 'Wiring' && activePill !== 'Labor' && activePill !== 'Maintenance'">
            <div class="accordion-card" *ngFor="let article of filteredArticles" [class.expanded]="article.expanded">
                <div class="accordion-header" (click)="toggleAccordion(article)">
                    <div class="accordion-title-group">
                        <h3 class="article-title">{{ article.title }}</h3>
                        <span class="article-subtitle" *ngIf="article.subtitle">{{ article.subtitle }}</span>
                    </div>
                    <div class="accordion-meta">
                        <span class="labor-time" *ngIf="article.laborTime">{{ article.laborTime }} Hr</span>
                        <i class="fas fa-chevron-down expand-icon"></i>
                    </div>
                </div>

                <div class="accordion-body">
                    <!-- Quick Access Info -->
                    <div class="quick-info-grid"
                        *ngIf="article.torqueSpecs || article.partNumber || article.description">
                        <div class="info-item" *ngIf="article.torqueSpecs">
                            <span class="info-label">Torque Spec:</span>
                            <span class="info-value">{{ article.torqueSpecs }}</span>
                        </div>
                        <div class="info-item" *ngIf="article.partNumber">
                            <span class="info-label">Part #:</span>
                            <span class="info-value">{{ article.partNumber }}</span>
                        </div>
                        <div class="info-item" *ngIf="article.description">
                            <span class="info-label">Info:</span>
                            <span class="info-value">{{ article.description }}</span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="action-btn primary" (click)="viewArticle(article)">
                            <i class="fas fa-eye"></i> VIEW
                        </button>
                        <button class="action-btn secondary glow-cyan" (click)="toggleXRayMode(article)"
                            *ngIf="activePill !== 'Specs' && activePill !== 'Specifications'">
                            <i class="fas fa-microchip"></i> X-RAY MODE
                        </button>
                    </div>

                    <!-- X-Ray SVG Container -->
                    <div class="xray-container" *ngIf="xRayMode">
                        <div class="xray-header">
                            <span class="xray-label">VECTOR SCHEMATIC // GROUP {{ vectorIllustration?.groupId ||
                                'LOADING' }}</span>
                            <div class="xray-controls">
                                <i class="fas fa-search-plus"></i>
                                <i class="fas fa-expand"></i>
                            </div>
                        </div>

                        <div class="loading-state" *ngIf="loadingVector">
                            <div class="cyber-spinner"></div>
                            <p>Scanning schematics...</p>
                        </div>

                        <div class="error-state" *ngIf="vectorError">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>{{ vectorError }}</p>
                        </div>

                        <div class="vector-diagram-svg" *ngIf="vectorIllustration && !loadingVector">
                            <img *ngIf="vectorIllustration.imageUrl" [src]="vectorIllustration.imageUrl"
                                alt="Component Location" class="xray-image">
                            <div *ngIf="vectorIllustration.svgContent" [innerHTML]="vectorIllustration.svgContent">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state"
            *ngIf="filteredArticles.length === 0 && !loading && !viewingArticle && activePill !== 'DTCs' && activePill !== 'Diagnostic Codes' && activePill !== 'Diagnostic Trouble Codes' && activePill !== 'TSBs' && activePill !== 'Wiring' && activePill !== 'Labor' && activePill !== 'Maintenance' && activePill !== 'Maintenance Schedules' && activePill !== 'Specs' && activePill !== 'Specifications'">
            <i class="fas fa-search"></i>
            <p>No procedures found for "{{ activePill }}"</p>
        </div>

        <!-- Loading State -->
        <div class="loading-state" *ngIf="loading">
            <div class="spinner"></div>
            <p>Loading vehicle data...</p>
        </div>

        <!-- DTC List -->
        <div class="feature-list dtc-list"
            *ngIf="activePill === 'DTCs' || activePill === 'Diagnostic Codes' || activePill === 'Diagnostic Trouble Codes'">
            <div class="feature-card dtc-card" *ngFor="let dtc of filteredArticles">
                <div class="card-header">
                    <span class="code">{{ dtc.code }}</span>
                    <span class="bucket-badge">{{ dtc.bucket }}</span>
                </div>
                <h4 class="dtc-description">{{ dtc.description }}</h4>
                <p class="dtc-subtitle" *ngIf="dtc.subtitle">{{ dtc.subtitle }}</p>

                <div class="dtc-actions">
                    <button class="action-btn small" (click)="viewArticle(dtc)">View Diagnostics</button>
                    <button class="action-btn small secondary" (click)="loadRelatedWiring(dtc)">
                        <i class="fas fa-project-diagram"></i> Linked Intel
                    </button>
                </div>

                <!-- Linked Intelligence Graph -->
                <div class="linked-intel-graph" *ngIf="relatedWiring && relatedWiring.dtcId === dtc.id">
                    <div class="intel-node root">
                        <span class="node-label">DTC {{ dtc.code }}</span>
                    </div>
                    <div class="intel-connector"></div>
                    <div class="intel-node target" (click)="expandImage(relatedWiring.url, relatedWiring.title)">
                        <span class="node-icon"><i class="fas fa-bolt"></i></span>
                        <span class="node-label">WIRING DIAGRAM</span>
                        <span class="node-sub">{{ relatedWiring.title }}</span>
                    </div>
                </div>
            </div>
            <div class="empty-state" *ngIf="filteredArticles.length === 0 && !loading">
                <i class="fas fa-exclamation-triangle"></i>
                <p>No DTCs found.</p>
            </div>
            <div class="loading-state" *ngIf="loading">
                <div class="spinner"></div>
                <p>Loading DTCs...</p>
            </div>
        </div>

        <!-- TSB List -->
        <div class="feature-list tsb-list" *ngIf="activePill === 'TSBs' || activePill === 'Service Bulletins'">
            <div class="feature-card tsb-card" *ngFor="let tsb of filteredArticles">
                <div class="card-header">
                    <span class="bulletin-id">{{ tsb.id }}</span>
                    <span class="date">{{ tsb.date }}</span>
                </div>
                <h3 class="title">{{ tsb.title }}</h3>
                <p class="summary">{{ tsb.summary }}</p>
                <button class="action-btn small" (click)="viewArticle(tsb)">View Bulletin</button>
            </div>
            <div class="empty-state" *ngIf="filteredArticles.length === 0 && !loading">
                <i class="fas fa-clipboard-list"></i>
                <p>No TSBs found.</p>
            </div>
            <div class="loading-state" *ngIf="loading">
                <div class="spinner"></div>
                <p>Loading TSBs...</p>
            </div>
        </div>

        <!-- Wiring Diagrams -->
        <div class="feature-grid wiring-grid" *ngIf="activePill === 'Wiring' || activePill === 'Diagrams'">
            <div class="wiring-card" *ngFor="let diagram of filteredArticles"
                (click)="expandImage(diagram.url, diagram.title)">
                <div class="thumbnail-wrapper">
                    <img [src]="diagram.thumbnail || diagram.url" alt="Wiring Diagram">
                    <div class="overlay"><i class="fas fa-search-plus"></i></div>
                </div>
                <p class="title">{{ diagram.title }}</p>
            </div>
            <div class="empty-state" *ngIf="filteredArticles.length === 0 && !loading">
                <i class="fas fa-project-diagram"></i>
                <p>No wiring diagrams found.</p>
            </div>
            <div class="loading-state" *ngIf="loading">
                <div class="spinner"></div>
                <p>Loading Diagrams...</p>
            </div>
        </div>

        <!-- Labor Times -->
        <div class="feature-list labor-list" *ngIf="activePill === 'Labor'">
            <div class="labor-table-card">
                <table class="cyber-table">
                    <thead>
                        <tr>
                            <th>Operation</th>
                            <th>Time (Hrs)</th>
                            <th>Skill</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let labor of filteredArticles">
                            <td>{{ labor.operation }}</td>
                            <td class="time">{{ labor.time }}</td>
                            <td>{{ labor.skillLevel }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="empty-state" *ngIf="(!laborData || laborData.length === 0) && !loading">
                <i class="fas fa-stopwatch"></i>
                <p>No labor times found.</p>
            </div>
            <div class="loading-state" *ngIf="loading">
                <div class="spinner"></div>
                <p>Loading Labor Times...</p>
            </div>
        </div>

        <!-- Maintenance View -->
        <div class="feature-list maintenance-list" *ngIf="activePill === 'Maintenance'">
            <div class="maintenance-section">
                <h3><i class="fas fa-calendar-alt"></i> Scheduled Maintenance (30k Miles)</h3>
                <div class="maintenance-grid">
                    <div class="maint-card" *ngFor="let item of maintenanceData.intervals">
                        <div class="maint-icon"><i class="fas fa-wrench"></i></div>
                        <div class="maint-info">
                            <h4>{{ item.serviceName }}</h4>
                            <p>{{ item.action }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="maintenance-section">
                <h3><i class="fas fa-tachometer-alt"></i> Indicator Based</h3>
                <div class="maintenance-grid">
                    <div class="maint-card" *ngFor="let item of maintenanceData.indicators">
                        <div class="maint-icon warning"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="maint-info">
                            <h4>{{ item.indicatorName }}</h4>
                            <p>{{ item.description }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="loading-state" *ngIf="loading">
                <div class="spinner"></div>
                <p>Loading Maintenance Schedules...</p>
            </div>
            <div class="empty-state"
                *ngIf="maintenanceData.intervals.length === 0 && maintenanceData.indicators.length === 0 && !loading">
                <i class="fas fa-calendar-times"></i>
                <p>No maintenance schedules found for this vehicle.</p>
            </div>
        </div>

        <!-- Updates / Track Changes -->
        <div class="feature-list updates-list" *ngIf="activePill === 'Updates'">
            <div class="updates-header">
                <label>Select Quarter:</label>
                <select [(ngModel)]="selectedQuarter" (change)="loadDeltaReport(selectedQuarter)">
                    <option *ngFor="let q of trackChangeQuarters" [value]="q">{{ q }}</option>
                </select>
            </div>

            <div class="updates-feed">
                <div class="update-card" *ngFor="let delta of trackChangeDeltas">
                    <div class="update-type" [class.added]="delta.type === 'ADD'"
                        [class.modified]="delta.type === 'MODIFY'">
                        {{ delta.type }}
                    </div>
                    <div class="update-content">
                        <h4>{{ delta.entityType }} - {{ delta.entityId }}</h4>
                        <p>{{ delta.description }}</p>
                    </div>
                </div>
            </div>

            <div class="empty-state" *ngIf="filteredArticles.length === 0 && !loading">
                <i class="fas fa-history"></i>
                <p>No updates found for this quarter.</p>
            </div>
            <div class="loading-state" *ngIf="loading">
                <div class="spinner"></div>
                <p>Loading Update History...</p>
            </div>
        </div>

        <!-- Article Viewer -->
        <div class="article-viewer" *ngIf="viewingArticle">
            <div class="viewer-header">
                <button class="close-btn" (click)="closeArticle()">
                    <i class="fas fa-arrow-left"></i> Back to List
                </button>
                <div class="ai-toggle">
                    <span class="ai-label">AI Enhance</span>
                    <label class="switch">
                        <input type="checkbox" [checked]="aiEnhanced" (change)="toggleAiEnhancement()"
                            [disabled]="enhancing">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <div class="viewer-content">
                <div *ngIf="loadingArticle" class="loading-article">
                    <div class="cyber-spinner"></div>
                    <p>{{ loadingMessage }}</p>
                </div>

                <div *ngIf="!loadingArticle" class="article-body" [innerHTML]="articleContent"
                    (click)="handleArticleClick($event)"></div>

                <!-- Labor Data Display -->
                <div *ngIf="laborData && !loadingArticle" class="labor-data-panel">
                    <h3>Labor Operation: {{ laborData.mainOperation.code }}</h3>
                    <div class="labor-details">
                        <div class="labor-row">
                            <span>Description:</span>
                            <strong>{{ laborData.mainOperation.description }}</strong>
                        </div>
                        <div class="labor-row">
                            <span>Time:</span>
                            <strong class="highlight-cyan">{{ laborData.mainOperation.time }} Hours</strong>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>




    <!-- Sticky Search Overlay -->
    <div class="sticky-search-overlay" *ngIf="showSearch" [@slideDown]>
        <div class="search-bar-sticky">
            <button class="back-btn" (click)="closeSearch()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="search-input-container">
                <i class="fas fa-search search-icon"></i>
                <input #searchInput type="text" placeholder="Search procedures, specs, wiring..."
                    [(ngModel)]="searchQuery" (ngModelChange)="onSearchInput()" autofocus>
            </div>
            <button *ngIf="searchQuery" class="clear-btn" (click)="clearSearch()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="search-results-info" *ngIf="searchQuery">
            <span>{{ filteredArticles.length }} results</span>
        </div>
    </div>






    <!-- Image Lightbox -->
    <div class="lightbox-overlay" *ngIf="expandedImage" (click)="closeImage()">
        <div class="lightbox-content" (click)="$event.stopPropagation()">
            <button class="close-lightbox" (click)="closeImage()">
                <i class="fas fa-times"></i>
            </button>

            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button class="zoom-btn" (click)="zoomIn()" title="Zoom In">
                    <i class="fas fa-search-plus"></i>
                </button>
                <span class="zoom-level">{{ imageZoom }}%</span>
                <button class="zoom-btn" (click)="zoomOut()" title="Zoom Out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button class="zoom-btn" (click)="resetZoom()" title="Reset Zoom">
                    <i class="fas fa-compress-arrows-alt"></i>
                </button>
            </div>

            <!-- Image Container with Pan -->
            <div class="image-container" (mousedown)="startPan($event)" (wheel)="onMouseWheel($event)">
                <img [src]="expandedImage.src" [alt]="expandedImage.alt"
                    [style.transform]="'scale(' + (imageZoom / 100) + ') translate(' + imagePanX + 'px, ' + imagePanY + 'px)'"
                    [style.cursor]="imageZoom > 100 ? 'grab' : 'default'">
            </div>

            <p class="lightbox-caption" *ngIf="expandedImage.alt">{{ expandedImage.alt }}</p>
            <p class="lightbox-hint">Use mouse wheel or buttons to zoom â€¢ Click and drag to pan</p>
        </div>
    </div>
</div>